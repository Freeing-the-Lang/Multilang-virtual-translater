name: "ðŸŒ Multilang Virtual Translater â€” Universal AST Prototype (v1.9)"

on:
  push:
    branches: [ main ]
    tags:
      - "v*"
  pull_request:
    types: [ closed ]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

concurrency:
  group: multilang-virtual-translater-${{ github.ref }}
  cancel-in-progress: false  # âœ… ì¤‘ë³µ ì‹¤í–‰ í—ˆìš©

jobs:
  build-test:
    name: "ðŸ§  Build & Test Universal AST"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    timeout-minutes: 20

    steps:
      - name: "ðŸ“¦ Checkout repository (safe auto-retry)"
        shell: bash
        run: |
          set -e
          echo "ðŸ” Attempting safe git checkout (max 3 retries)..."
          for i in 1 2 3; do
            if git clone --recursive https://github.com/${{ github.repository }} .; then
              echo "âœ… Checkout successful."
              break
            else
              echo "âš ï¸ Retry $i failed. Waiting 10s..."
              sleep 10
            fi
          done

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          check-latest: true

      - name: "âš™ï¸ Install dependencies (auto-retry)"
        shell: bash
        run: |
          set -e
          echo "ðŸ” Upgrading pip..."
          for i in 1 2 3; do
            python -m pip install --upgrade pip && break || { echo "âš ï¸ Retry $i failed"; sleep 5; }
          done
          echo "ðŸ“¦ Installing required packages..."
          for i in 1 2 3; do
            pip install tree_sitter pytest && break || { echo "âš ï¸ Retry $i failed"; sleep 5; }
          done

      - name: "ðŸ§© Run AST tests & Save JSON"
        shell: bash
        run: |
          mkdir -p tests artifacts
          echo 'def add(a,b): return a+b' > tests/sample.py
          python - <<'EOF'
          import json
          from parsers.parser_python import PythonParser
          from generators.generator_python import PythonGenerator

          code = open("tests/sample.py").read()
          root = PythonParser().parse(code)
          out = PythonGenerator().generate(root)

          print("Generated:\n", out)
          with open("artifacts/universal_ast.json", "w") as f:
              json.dump(root.to_dict(), f, indent=2)
          EOF

      - name: "ðŸªµ Archive logs & AST output"
        if: always()
        shell: bash
        run: |
          echo "AST Log $(date)" > artifacts/ledger.txt
          cd artifacts
          tar -czf ../multilang_logs_${{ matrix.os }}.tar.gz .
          cd ..

      - name: "ðŸ“¤ Upload artifacts (OS-specific)"
        uses: actions/upload-artifact@v4
        with:
          name: multilang-virtual-artifacts-${{ matrix.os }}-${{ github.job }}-${{ github.run_id }}
          path: |
            multilang_logs_${{ matrix.os }}.tar.gz
            artifacts/universal_ast.json

  proof-ledger:
    name: "ðŸ§¾ ProofLedger Sync"
    runs-on: ubuntu-latest
    needs: build-test
    timeout-minutes: 10

    steps:
      - name: "ðŸ§­ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "ðŸ“œ Generate ProofLedger"
        shell: bash
        run: |
          echo "Multilang Virtual Translater ProofLedger" > PROOFLEDGER.txt
          echo "Timestamp:" $(date) >> PROOFLEDGER.txt
          for os in ubuntu-latest macos-latest windows-latest; do
            file="multilang_logs_${os}.tar.gz"
            [ -f "$file" ] && echo "SHA256 ($os): $(sha256sum $file | cut -d' ' -f1)" >> PROOFLEDGER.txt || echo "SHA256 ($os): N/A" >> PROOFLEDGER.txt
          done
          cat PROOFLEDGER.txt

      - name: "ðŸª£ Commit ProofLedger"
        shell: bash
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add PROOFLEDGER.txt
          git commit -m "Update ProofLedger [auto]" || echo "No changes to commit"
          git push || echo "Push skipped (no changes)"

  release:
    name: "ðŸš€ Auto Release (tag-based)"
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-test, proof-ledger]
    timeout-minutes: 10

    steps:
      - name: "ðŸ“¦ Checkout"
        uses: actions/checkout@v4

      - name: "ðŸ§¾ Create Release"
        uses: softprops/action-gh-release@v2
        with:
          files: |
            multilang_logs_ubuntu-latest.tar.gz
            multilang_logs_macos-latest.tar.gz
            multilang_logs_windows-latest.tar.gz
            artifacts/universal_ast.json
            PROOFLEDGER.txt
          body: |
            ðŸ”– **Multilang Virtual Translater â€” Universal AST Snapshot**
            - Version: ${{ github.ref_name }}
            - Includes OS-specific AST logs + Universal AST JSON + ProofLedger hashes
            - Generated automatically via v1.9 workflow
